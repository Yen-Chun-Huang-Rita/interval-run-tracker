<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é–“æ­‡é‹å‹•è¨ˆæ™‚å™¨</title>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; text-align: center; background-color: #f4f4f9; color: #333; padding: 20px; }
        .container { max-width: 400px; margin: 0 auto; background: white; padding: 20px; border-radius: 10px; box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
        input { width: 60px; padding: 5px; margin: 5px; text-align: center; }
        button { padding: 10px 20px; font-size: 16px; margin-top: 15px; cursor: pointer; background-color: #007bff; color: white; border: none; border-radius: 5px; }
        button:hover { background-color: #0056b3; }
        .btn-pause { background-color: #ffc107; color: #333; }
        .btn-pause:hover { background-color: #e0a800; }
        .btn-resume { background-color: #28a745; color: white; }
        .btn-resume:hover { background-color: #218838; }
        #timer-display { font-size: 64px; font-weight: bold; margin: 20px 0; color: #333; }
        #status { font-size: 28px; font-weight: bold; margin-bottom: 10px; }
        .walking { background-color: #ffe8cc !important; }
        .jogging { background-color: #ccffcc !important; }
        table { width: 100%; margin-top: 20px; border-collapse: collapse; font-size: 14px; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: center; }
        th { background-color: #f2f2f2; }
        .history-section { margin-top: 30px; border-top: 2px solid #eee; padding-top: 20px; }
    </style>
</head>
<body id="bg">

<div class="container">
    <h2>â±ï¸ é–“æ­‡é‹å‹•è¨ˆæ™‚å™¨</h2>
    
    <div id="setup">
        <label>å¿«èµ° (åˆ†é˜): <input type="number" id="walk-min" value="1" step="0.1"></label><br>
        <label>æ…¢è·‘ (åˆ†é˜): <input type="number" id="jog-min" value="1" step="0.1"></label><br>
        <label>ç¸½çµ„æ•¸: <input type="number" id="sets" value="5"></label><br>
        <button onclick="startWorkout()">é–‹å§‹è¨“ç·´</button>
    </div>

    <div id="workout-area" style="display:none;">
        <div id="status">æº–å‚™ä¸­...</div>
        <div id="timer-display">00:00</div>
        <div id="set-display"></div>
        <button id="pause-btn" class="btn-pause" onclick="togglePause()">æš«åœ</button>
        <button onclick="finishWorkout()" style="background-color: #dc3545;">çµæŸè¨“ç·´</button>
    </div>

    <div class="history-section">
        <h3>ğŸ“‹ é‹å‹•ç´€éŒ„</h3>
        <button onclick="downloadCSV()" style="background-color: #17a2b8; font-size: 14px; padding: 5px 10px;">ä¸‹è¼‰ CSV ç´€éŒ„</button>
        <table id="history-table">
            <thead>
                <tr>
                    <th>æ—¥æœŸ</th>
                    <th>è¨­å®š(åˆ†)</th>
                    <th>ç¸½æ™‚é–“(åˆ†)</th>
                </tr>
            </thead>
            <tbody id="history-body"></tbody>
        </table>
    </div>
</div>

<script>
    let timer;
    let isWalkingPhase = true;
    let isPaused = false;
    let currentSet = 1;
    let totalSets = 0;
    let walkSec = 0;
    let jogSec = 0;
    let timeLeft = 0;
    let audioCtx;

    window.onload = updateHistoryTable;

    // å•Ÿå‹•éŸ³æ•ˆç’°å¢ƒ (è§£æ±ºæ‰‹æ©Ÿç€è¦½å™¨å¿…é ˆç”±ä½¿ç”¨è€…é»æ“Šæ‰èƒ½ç™¼å‡ºè²éŸ³çš„é™åˆ¶)
    function initAudio() {
        if (!audioCtx) {
            const AudioContext = window.AudioContext || window.webkitAudioContext;
            audioCtx = new AudioContext();
        }
        if (audioCtx.state === 'suspended') {
            audioCtx.resume();
        }
    }

    function playBeep(freq, type, duration) {
        if (!audioCtx) return;
        const osc = audioCtx.createOscillator();
        const gainNode = audioCtx.createGain();
        osc.type = type;
        osc.frequency.setValueAtTime(freq, audioCtx.currentTime);
        osc.connect(gainNode);
        gainNode.connect(audioCtx.destination);
        osc.start();
        gainNode.gain.exponentialRampToValueAtTime(0.00001, audioCtx.currentTime + duration);
        osc.stop(audioCtx.currentTime + duration);
    }

    function startWorkout() {
        initAudio(); 
        
        let wMin = parseFloat(document.getElementById('walk-min').value);
        let jMin = parseFloat(document.getElementById('jog-min').value);
        totalSets = parseInt(document.getElementById('sets').value);

        if (isNaN(wMin) || isNaN(jMin) || isNaN(totalSets) || wMin <= 0 || jMin <= 0 || totalSets <= 0) {
            alert("è«‹è¼¸å…¥æœ‰æ•ˆçš„æ•¸å­—ï¼");
            return;
        }

        walkSec = Math.round(wMin * 60);
        jogSec = Math.round(jMin * 60);

        document.getElementById('setup').style.display = 'none';
        document.getElementById('workout-area').style.display = 'block';
        
        currentSet = 1;
        isWalkingPhase = true;
        isPaused = false;
        timeLeft = walkSec;
        
        resetPauseButton();
        updateUI();
        
        clearInterval(timer);
        timer = setInterval(countdown, 1000);
    }

    function togglePause() {
        isPaused = !isPaused;
        const btn = document.getElementById('pause-btn');
        if (isPaused) {
            btn.innerText = "ç¹¼çºŒ";
            btn.className = "btn-resume";
        } else {
            btn.innerText = "æš«åœ";
            btn.className = "btn-pause";
        }
    }

    function resetPauseButton() {
        const btn = document.getElementById('pause-btn');
        btn.innerText = "æš«åœ";
        btn.className = "btn-pause";
    }

    function countdown() {
        if (isPaused) return;

        timeLeft--;
        updateUI();

        // å€’æ•¸ 5, 4, 3, 2, 1 ç§’æ™‚ç™¼å‡ºçŸ­éŸ³
        if (timeLeft <= 5 && timeLeft > 0) {
            playBeep(1000, "sine", 0.15);
        }

        if (timeLeft <= 0) {
            if (isWalkingPhase) {
                if (currentSet >= totalSets) {
                    playBeep(600, "square", 0.8);
                    finishWorkout();
                    return;
                }
                isWalkingPhase = false;
                timeLeft = jogSec;
                playBeep(800, "square", 0.5); // åˆ‡æ›éšæ®µé•·éŸ³
            } else {
                currentSet++;
                isWalkingPhase = true;
                timeLeft = walkSec;
                playBeep(800, "square", 0.5); // åˆ‡æ›éšæ®µé•·éŸ³
            }
            updateUI();
        }
    }

    function formatTime(seconds) {
        const m = Math.floor(seconds / 60).toString().padStart(2, '0');
        const s = (seconds % 60).toString().padStart(2, '0');
        return `${m}:${s}`;
    }

    function updateUI() {
        document.getElementById('timer-display').innerText = formatTime(timeLeft);
        document.getElementById('set-display').innerText = `ç¬¬ ${currentSet} çµ„ / å…± ${totalSets} çµ„`;
        
        const statusEl = document.getElementById('status');
        const bg = document.getElementById('bg');

        if (isWalkingPhase) {
            statusEl.innerText = "ğŸš¶ å¿«èµ°éšæ®µ";
            statusEl.style.color = "#d35400";
            bg.className = "walking";
        } else {
            statusEl.innerText = "ğŸƒ æ…¢è·‘éšæ®µ";
            statusEl.style.color = "#27ae60";
            bg.className = "jogging";
        }
    }

    function finishWorkout() {
        clearInterval(timer);
        document.getElementById('status').innerText = "ğŸ‰ è¨“ç·´å®Œæˆï¼";
        document.getElementById('bg').className = "";
        document.getElementById('timer-display').innerText = "00:00";
        
        saveRecord();
        
        setTimeout(() => {
            alert("å¤ªæ£’äº†ï¼è¾›è‹¦äº†ï¼");
            document.getElementById('setup').style.display = 'block';
            document.getElementById('workout-area').style.display = 'none';
        }, 500);
    }

    function saveRecord() {
        const totalTimeMin = (((walkSec * totalSets) + (jogSec * (totalSets - 1))) / 60).toFixed(1);
        const now = new Date();
        const dateStr = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}-${String(now.getDate()).padStart(2,'0')} ${String(now.getHours()).padStart(2,'0')}:${String(now.getMinutes()).padStart(2,'0')}`;
        
        const wMin = document.getElementById('walk-min').value;
        const jMin = document.getElementById('jog-min').value;

        const record = { date: dateStr, setting: `å¿«${wMin}/æ…¢${jMin}/${totalSets}çµ„`, total: totalTimeMin };
        
        let history = JSON.parse(localStorage.getItem('workoutHistory')) || [];
        history.push(record);
        localStorage.setItem('workoutHistory', JSON.stringify(history));
        
        updateHistoryTable();
    }

    function updateHistoryTable() {
        let history = JSON.parse(localStorage.getItem('workoutHistory')) || [];
        const tbody = document.getElementById('history-body');
        tbody.innerHTML = '';
        
        history.slice().reverse().forEach(row => {
            let tr = document.createElement('tr');
            tr.innerHTML = `<td>${row.date}</td><td>${row.setting}</td><td>${row.total}</td>`;
            tbody.appendChild(tr);
        });
    }

    function downloadCSV() {
        let history = JSON.parse(localStorage.getItem('workoutHistory')) || [];
        if (history.length === 0) {
            alert("ç›®å‰æ²’æœ‰ç´€éŒ„å¯ä¾›ä¸‹è¼‰ï¼");
            return;
        }

        let csvContent = "data:text/csv;charset=utf-8,\uFEFF";
        csvContent += "æ—¥æœŸ,è¨­å®š(å¿«èµ°åˆ†/æ…¢è·‘åˆ†/çµ„æ•¸),ç¸½èŠ±è²»æ™‚é–“(åˆ†)\n";
        
        history.forEach(row => {
            csvContent += `${row.date},${row.setting},${row.total}\n`;
        });

        const encodedUri = encodeURI(csvContent);
        const link = document.createElement("a");
        link.setAttribute("href", encodedUri);
        link.setAttribute("download", "workout_log.csv");
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }
</script>

</body>
</html>

