<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>é›å›çš„é–“æ­‡è¨“ç·´è¨ˆæ™‚å™¨ ğŸ’ª</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700;900&display=swap');

    :root {
      --walk-from: #f7971e;
      --walk-to: #ffd200;
      --jog-from: #11998e;
      --jog-to: #38ef7d;
      --rest-from: #667eea;
      --rest-to: #764ba2;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: 'Noto Sans TC', 'Segoe UI', sans-serif;
      min-height: 100vh;
      background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
      overflow-x: hidden;
    }

    /* Animated background particles */
    .bg-particles {
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      pointer-events: none;
      z-index: 0;
      overflow: hidden;
    }
    .particle {
      position: absolute;
      border-radius: 50%;
      opacity: 0.15;
      animation: float linear infinite;
    }
    @keyframes float {
      0% { transform: translateY(100vh) rotate(0deg); opacity: 0; }
      10% { opacity: 0.15; }
      90% { opacity: 0.15; }
      100% { transform: translateY(-100px) rotate(720deg); opacity: 0; }
    }

    .app {
      position: relative;
      z-index: 1;
      width: 100%;
      max-width: 420px;
    }

    /* â”€â”€ Header â”€â”€ */
    .header {
      text-align: center;
      margin-bottom: 24px;
      animation: slideDown 0.6s ease;
    }
    @keyframes slideDown {
      from { transform: translateY(-30px); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }
    .header h1 {
      font-size: 1.8rem;
      font-weight: 900;
      color: #fff;
      letter-spacing: 2px;
      text-shadow: 0 0 20px rgba(255,255,255,0.3);
    }
    .header .subtitle {
      font-size: 0.85rem;
      color: rgba(255,255,255,0.5);
      margin-top: 4px;
      letter-spacing: 1px;
    }

    /* â”€â”€ Card â”€â”€ */
    .card {
      background: rgba(255, 255, 255, 0.07);
      backdrop-filter: blur(20px);
      border: 1px solid rgba(255,255,255,0.12);
      border-radius: 28px;
      padding: 28px 24px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.4);
      animation: slideUp 0.6s ease;
    }
    @keyframes slideUp {
      from { transform: translateY(30px); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }

    /* â”€â”€ Setup Panel â”€â”€ */
    #setup { display: block; }
    .section-title {
      font-size: 0.8rem;
      font-weight: 700;
      color: rgba(255,255,255,0.4);
      letter-spacing: 2px;
      text-transform: uppercase;
      margin-bottom: 16px;
    }

    .input-group {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 12px 0;
      border-bottom: 1px solid rgba(255,255,255,0.06);
    }
    .input-group:last-of-type { border-bottom: none; }
    .input-label {
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 0.95rem;
      color: rgba(255,255,255,0.85);
      font-weight: 700;
    }
    .input-label .emoji { font-size: 1.3rem; }
    .input-label .unit {
      font-size: 0.75rem;
      color: rgba(255,255,255,0.4);
      font-weight: 400;
    }

    .number-control {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .num-btn {
      width: 32px; height: 32px;
      border-radius: 50%;
      border: none;
      background: rgba(255,255,255,0.12);
      color: #fff;
      font-size: 1.2rem;
      font-weight: 700;
      cursor: pointer;
      display: flex; align-items: center; justify-content: center;
      transition: all 0.15s;
      line-height: 1;
    }
    .num-btn:hover { background: rgba(255,255,255,0.22); transform: scale(1.1); }
    .num-btn:active { transform: scale(0.95); }
    .num-input {
      width: 52px;
      background: rgba(255,255,255,0.1);
      border: 1px solid rgba(255,255,255,0.2);
      border-radius: 10px;
      color: #fff;
      font-size: 1.05rem;
      font-weight: 700;
      text-align: center;
      padding: 6px 4px;
      outline: none;
      font-family: inherit;
    }
    .num-input:focus { border-color: rgba(255,255,255,0.5); }

    /* Total time preview */
    .total-preview {
      margin: 20px 0;
      background: linear-gradient(135deg, rgba(102,126,234,0.2), rgba(118,75,162,0.2));
      border: 1px solid rgba(102,126,234,0.3);
      border-radius: 16px;
      padding: 14px 20px;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    .total-preview .label { font-size: 0.85rem; color: rgba(255,255,255,0.6); }
    .total-preview .value { font-size: 1.4rem; font-weight: 900; color: #a78bfa; }

    /* Start button */
    .btn-start {
      width: 100%;
      padding: 16px;
      border: none;
      border-radius: 18px;
      background: linear-gradient(135deg, #667eea, #764ba2);
      color: #fff;
      font-size: 1.1rem;
      font-weight: 900;
      letter-spacing: 2px;
      cursor: pointer;
      transition: all 0.2s;
      box-shadow: 0 8px 24px rgba(102,126,234,0.4);
      position: relative;
      overflow: hidden;
    }
    .btn-start::before {
      content: '';
      position: absolute;
      top: 0; left: -100%;
      width: 100%; height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
      transition: left 0.4s;
    }
    .btn-start:hover::before { left: 100%; }
    .btn-start:hover { transform: translateY(-2px); box-shadow: 0 12px 32px rgba(102,126,234,0.5); }
    .btn-start:active { transform: translateY(0); }

    /* â”€â”€ Workout Panel â”€â”€ */
    #workout-area { display: none; }

    /* Phase indicator */
    .phase-bar {
      display: flex;
      border-radius: 12px;
      overflow: hidden;
      margin-bottom: 20px;
      height: 6px;
      gap: 3px;
    }
    .phase-seg {
      flex: 1;
      border-radius: 3px;
      background: rgba(255,255,255,0.1);
      transition: background 0.3s;
    }
    .phase-seg.walk-done { background: linear-gradient(90deg, var(--walk-from), var(--walk-to)); }
    .phase-seg.jog-done { background: linear-gradient(90deg, var(--jog-from), var(--jog-to)); }
    .phase-seg.active { background: rgba(255,255,255,0.6); animation: pulse-seg 0.8s ease-in-out infinite alternate; }
    @keyframes pulse-seg { from { opacity: 0.6; } to { opacity: 1; } }

    /* Status */
    .status-row {
      text-align: center;
      margin-bottom: 16px;
    }
    .status-badge {
      display: inline-block;
      padding: 6px 20px;
      border-radius: 50px;
      font-size: 0.9rem;
      font-weight: 900;
      letter-spacing: 1px;
      transition: all 0.4s ease;
    }
    .badge-walk {
      background: linear-gradient(135deg, var(--walk-from), var(--walk-to));
      color: #1a1a2e;
      box-shadow: 0 4px 16px rgba(247,151,30,0.4);
    }
    .badge-jog {
      background: linear-gradient(135deg, var(--jog-from), var(--jog-to));
      color: #fff;
      box-shadow: 0 4px 16px rgba(17,153,142,0.4);
    }
    .badge-done {
      background: linear-gradient(135deg, #f093fb, #f5576c);
      color: #fff;
      box-shadow: 0 4px 16px rgba(245,87,108,0.4);
    }

    /* Set info */
    .set-info {
      text-align: center;
      font-size: 0.82rem;
      color: rgba(255,255,255,0.4);
      margin-bottom: 10px;
      letter-spacing: 1px;
    }

    /* Circular timer */
    .timer-container {
      position: relative;
      width: 220px;
      height: 220px;
      margin: 0 auto 20px;
    }
    .timer-svg {
      width: 100%;
      height: 100%;
      transform: rotate(-90deg);
    }
    .timer-track {
      fill: none;
      stroke: rgba(255,255,255,0.08);
      stroke-width: 8;
    }
    .timer-progress {
      fill: none;
      stroke-width: 8;
      stroke-linecap: round;
      stroke-dasharray: 628;
      stroke-dashoffset: 0;
      transition: stroke-dashoffset 0.9s linear, stroke 0.4s ease;
    }
    .timer-inner {
      position: absolute;
      top: 50%; left: 50%;
      transform: translate(-50%, -50%);
      text-align: center;
    }
    .timer-display {
      font-size: 3.2rem;
      font-weight: 900;
      color: #fff;
      letter-spacing: 2px;
      line-height: 1;
      text-shadow: 0 0 30px rgba(255,255,255,0.3);
    }
    .timer-label {
      font-size: 0.7rem;
      color: rgba(255,255,255,0.35);
      letter-spacing: 1px;
      margin-top: 4px;
    }

    /* Motivation message */
    .motivation {
      text-align: center;
      font-size: 0.92rem;
      color: rgba(255,255,255,0.7);
      margin-bottom: 20px;
      min-height: 22px;
      font-style: italic;
      transition: opacity 0.3s;
    }

    /* Control buttons */
    .control-btns {
      display: flex;
      gap: 10px;
      justify-content: center;
      margin-bottom: 14px;
    }
    .btn-control {
      flex: 1;
      padding: 13px 10px;
      border: none;
      border-radius: 14px;
      font-size: 0.9rem;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.2s;
      letter-spacing: 0.5px;
    }
    .btn-pause-resume {
      background: linear-gradient(135deg, #f7971e, #ffd200);
      color: #1a1a2e;
      box-shadow: 0 4px 14px rgba(247,151,30,0.3);
    }
    .btn-pause-resume:hover { transform: translateY(-2px); box-shadow: 0 8px 20px rgba(247,151,30,0.4); }
    .btn-pause-resume.is-paused {
      background: linear-gradient(135deg, #11998e, #38ef7d);
      color: #fff;
      box-shadow: 0 4px 14px rgba(17,153,142,0.3);
    }
    .btn-stop {
      background: rgba(255,255,255,0.08);
      border: 1px solid rgba(255,255,255,0.12);
      color: rgba(255,255,255,0.6);
      box-shadow: none;
    }
    .btn-stop:hover { background: rgba(239,68,68,0.2); border-color: rgba(239,68,68,0.4); color: #f87171; }

    /* Countdown warning animation */
    @keyframes heartbeat {
      0%, 100% { transform: scale(1); }
      14% { transform: scale(1.12); }
      28% { transform: scale(1); }
      42% { transform: scale(1.08); }
      70% { transform: scale(1); }
    }
    .heartbeat { animation: heartbeat 0.8s ease; }

    /* Completion celebration */
    .celebration {
      text-align: center;
      padding: 10px 0;
    }
    .celebration .trophy { font-size: 3.5rem; display: block; margin-bottom: 8px; animation: bounce 0.6s ease infinite alternate; }
    @keyframes bounce { from { transform: translateY(0); } to { transform: translateY(-10px); } }
    .celebration .congrats { font-size: 1.3rem; font-weight: 900; color: #fff; margin-bottom: 4px; }
    .celebration .personal-msg { font-size: 1rem; color: #ffd200; font-weight: 700; margin-bottom: 8px; }
    .celebration .encourage { font-size: 0.88rem; color: rgba(255,255,255,0.6); }
    .btn-finish {
      margin-top: 16px;
      width: 100%;
      padding: 14px;
      border: none;
      border-radius: 14px;
      background: linear-gradient(135deg, #f093fb, #f5576c);
      color: #fff;
      font-size: 1rem;
      font-weight: 900;
      cursor: pointer;
      transition: all 0.2s;
      letter-spacing: 1px;
      box-shadow: 0 6px 20px rgba(245,87,108,0.35);
    }
    .btn-finish:hover { transform: translateY(-2px); box-shadow: 0 10px 28px rgba(245,87,108,0.5); }

    /* â”€â”€ History â”€â”€ */
    .history-section {
      margin-top: 20px;
      padding-top: 20px;
      border-top: 1px solid rgba(255,255,255,0.08);
    }
    .history-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 12px;
    }
    .history-title {
      font-size: 0.85rem;
      font-weight: 700;
      color: rgba(255,255,255,0.5);
      letter-spacing: 1px;
    }
    .history-actions { display: flex; gap: 6px; }
    .btn-small {
      padding: 5px 12px;
      border: 1px solid rgba(255,255,255,0.15);
      border-radius: 8px;
      background: rgba(255,255,255,0.06);
      color: rgba(255,255,255,0.55);
      font-size: 0.75rem;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.15s;
    }
    .btn-small:hover { background: rgba(255,255,255,0.12); color: #fff; }

    .history-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.78rem;
    }
    .history-table th {
      color: rgba(255,255,255,0.3);
      font-weight: 700;
      padding: 6px 4px;
      text-align: left;
      letter-spacing: 0.5px;
      border-bottom: 1px solid rgba(255,255,255,0.07);
    }
    .history-table td {
      color: rgba(255,255,255,0.65);
      padding: 7px 4px;
      border-bottom: 1px solid rgba(255,255,255,0.04);
    }
    .history-table tr:last-child td { border-bottom: none; }
    .btn-del {
      padding: 3px 8px;
      border: 1px solid rgba(239,68,68,0.3);
      border-radius: 5px;
      background: transparent;
      color: rgba(239,68,68,0.6);
      font-size: 0.7rem;
      cursor: pointer;
      transition: all 0.15s;
    }
    .btn-del:hover { background: rgba(239,68,68,0.15); color: #f87171; }

    /* Confetti */
    .confetti-piece {
      position: fixed;
      width: 10px;
      height: 10px;
      border-radius: 2px;
      top: -10px;
      animation: confetti-fall linear forwards;
      pointer-events: none;
      z-index: 999;
    }
    @keyframes confetti-fall {
      0% { transform: translateY(0) rotate(0deg); opacity: 1; }
      100% { transform: translateY(110vh) rotate(720deg); opacity: 0; }
    }
  </style>
</head>
<body>

<!-- Background Particles -->
<div class="bg-particles" id="bg-particles"></div>

<div class="app">
  <div class="header">
    <h1>ğŸ’ª é–“æ­‡è¨“ç·´è¨ˆæ™‚å™¨</h1>
    <div class="subtitle">é›å›çš„å°ˆå±¬é‹å‹•å¤¥ä¼´</div>
  </div>

  <div class="card">

    <!-- Setup Panel -->
    <div id="setup">
      <div class="section-title">è¨­å®šè¨“ç·´åƒæ•¸</div>

      <div class="input-group">
        <div class="input-label">
          <span class="emoji">ğŸš¶</span>
          <span>å¿«èµ°æ™‚é–“ <span class="unit">ï¼ˆåˆ†é˜ï¼‰</span></span>
        </div>
        <div class="number-control">
          <button class="num-btn" onclick="adjustValue('walk-min', -0.5)">âˆ’</button>
          <input class="num-input" type="number" id="walk-min" value="1" step="0.5" min="0.5" oninput="calcTotal()">
          <button class="num-btn" onclick="adjustValue('walk-min', 0.5)">+</button>
        </div>
      </div>

      <div class="input-group">
        <div class="input-label">
          <span class="emoji">ğŸƒ</span>
          <span>æ…¢è·‘æ™‚é–“ <span class="unit">ï¼ˆåˆ†é˜ï¼‰</span></span>
        </div>
        <div class="number-control">
          <button class="num-btn" onclick="adjustValue('jog-min', -0.5)">âˆ’</button>
          <input class="num-input" type="number" id="jog-min" value="1" step="0.5" min="0.5" oninput="calcTotal()">
          <button class="num-btn" onclick="adjustValue('jog-min', 0.5)">+</button>
        </div>
      </div>

      <div class="input-group">
        <div class="input-label">
          <span class="emoji">ğŸ”</span>
          <span>è¨“ç·´çµ„æ•¸ <span class="unit">ï¼ˆçµ„ï¼‰</span></span>
        </div>
        <div class="number-control">
          <button class="num-btn" onclick="adjustValue('sets', -1)">âˆ’</button>
          <input class="num-input" type="number" id="sets" value="5" step="1" min="1" oninput="calcTotal()">
          <button class="num-btn" onclick="adjustValue('sets', 1)">+</button>
        </div>
      </div>

      <div class="total-preview">
        <span class="label">â± é ä¼°ç¸½æ™‚é–“</span>
        <span class="value" id="est-total">9.0 åˆ†é˜</span>
      </div>

      <button class="btn-start" onclick="startWorkout()">ğŸš€ é–‹å§‹è¨“ç·´ï¼</button>

      <!-- History Section (visible in setup) -->
      <div class="history-section">
        <div class="history-header">
          <span class="history-title">ğŸ“‹ é‹å‹•ç´€éŒ„</span>
          <div class="history-actions">
            <button class="btn-small" onclick="downloadCSV()">ğŸ“¥ CSV</button>
            <button class="btn-small" onclick="clearAll()" style="border-color:rgba(239,68,68,0.3);color:rgba(239,68,68,0.6)">ğŸ—‘ æ¸…ç©º</button>
          </div>
        </div>
        <table class="history-table">
          <thead>
            <tr>
              <th>æ—¥æœŸæ™‚é–“</th>
              <th>è¨­å®š</th>
              <th>æ™‚é–“(åˆ†)</th>
              <th></th>
            </tr>
          </thead>
          <tbody id="history-body"></tbody>
        </table>
      </div>
    </div>

    <!-- Workout Panel -->
    <div id="workout-area">

      <!-- Completion screen -->
      <div id="completion-screen" style="display:none">
        <div class="celebration">
          <span class="trophy">ğŸ†</span>
          <div class="congrats">è¨“ç·´å®Œæˆï¼</div>
          <div class="personal-msg">é›å›ä½ çœŸçš„å¾ˆæ£’ï¼</div>
          <div class="encourage">æ±—æ°´æ˜¯æœ€ç¾çš„å‹³ç«  âœ¨<br>ä¸‹æ¬¡ç¹¼çºŒåŠªåŠ›ï¼Œä½ åšåˆ°äº†ï¼</div>
        </div>
        <button class="btn-finish" onclick="resetToSetup()">ğŸ’ª å†ä¾†ä¸€æ¬¡ï¼</button>
      </div>

      <!-- Active workout -->
      <div id="active-workout">
        <!-- Phase progress bar -->
        <div class="phase-bar" id="phase-bar"></div>

        <!-- Set info -->
        <div class="set-info" id="set-info">ç¬¬ 1 çµ„ / å…± 5 çµ„</div>

        <!-- Status badge -->
        <div class="status-row">
          <span class="status-badge badge-walk" id="status-badge">ğŸš¶ å¿«èµ°éšæ®µ</span>
        </div>

        <!-- Circular timer -->
        <div class="timer-container">
          <svg class="timer-svg" viewBox="0 0 220 220">
            <circle class="timer-track" cx="110" cy="110" r="100"/>
            <circle class="timer-progress" id="timer-arc" cx="110" cy="110" r="100"
              stroke="url(#walkGrad)"/>
            <defs>
              <linearGradient id="walkGrad" x1="0%" y1="0%" x2="100%" y2="0%">
                <stop offset="0%" style="stop-color:#f7971e"/>
                <stop offset="100%" style="stop-color:#ffd200"/>
              </linearGradient>
              <linearGradient id="jogGrad" x1="0%" y1="0%" x2="100%" y2="0%">
                <stop offset="0%" style="stop-color:#11998e"/>
                <stop offset="100%" style="stop-color:#38ef7d"/>
              </linearGradient>
            </defs>
          </svg>
          <div class="timer-inner">
            <div class="timer-display" id="timer-display">01:00</div>
            <div class="timer-label">å‰©é¤˜æ™‚é–“</div>
          </div>
        </div>

        <!-- Motivation message -->
        <div class="motivation" id="motivation-msg">æº–å‚™å¥½äº†å—ï¼ŸåŠ æ²¹ï¼</div>

        <!-- Control buttons -->
        <div class="control-btns">
          <button class="btn-control btn-pause-resume" id="pause-btn" onclick="togglePause()">â¸ æš«åœ</button>
          <button class="btn-control btn-stop" onclick="confirmStop()">â¹ çµæŸ</button>
        </div>
      </div>

    </div>
  </div>
</div>

<script>
// â”€â”€ State â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let timer = null;
let isWalkPhase = true;
let isPaused = false;
let currentSet = 1;
let totalSets = 0;
let walkSec = 0;
let jogSec = 0;
let timeLeft = 0;
let phaseTotalSec = 0;
let audioCtx = null;
let wakeLock = null;

// â”€â”€ Motivation Messages â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const WALK_MSGS = [
  "æ”¾è¼•é¬†ï¼Œèª¿æ•´å‘¼å¸ï¼",
  "äº«å—å¿«èµ°çš„ç¯€å¥ ğŸµ",
  "æ£’æ£’çš„ï¼ä¿æŒæ­¥ä¼ï¼",
  "é€™æ®µè·¯ç¨‹ä½ æœ€ç©©ï¼",
  "å¿«èµ°ä¹Ÿæ˜¯å¾ˆæ£’çš„é›éŠï¼",
  "å‘¼å¸ï¼Œæ”¾é¬†ï¼Œå‰é€²ï¼",
];
const JOG_MSGS = [
  "è¡å•Šï¼é›å›è¶…å¼·çš„ï¼ğŸ’ª",
  "è·‘èµ·ä¾†ï¼ä½ åšå¾—åˆ°ï¼ğŸ”¥",
  "åŠ é€Ÿï¼æ„Ÿå—åŠ›é‡ï¼âš¡",
  "ç‡ƒç‡’å§ï¼ä½ æ˜¯æœ€æ£’çš„ï¼",
  "å…¨åŠ›ä»¥èµ´ï¼GO GO GOï¼",
  "é›å›åŠ æ²¹ï¼è¶…è¶Šè‡ªå·±ï¼ğŸš€",
];
const COUNTDOWN_MSGS = [
  "å€’æ•¸è¨ˆæ™‚ï¼æº–å‚™åˆ‡æ›ï¼",
  "å¿«åˆ°äº†ï¼æ’ä½ï¼",
  "å·®ä¸€é»äº†ï¼ç¹¼çºŒï¼",
  "æœ€å¾Œå¹¾ç§’ï¼Œè¡è¡è¡ï¼",
  "å¿«æ›äº†ï¼æº–å‚™å¥½ï¼",
];

// â”€â”€ Background Particles â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function initParticles() {
  const container = document.getElementById('bg-particles');
  const colors = ['#667eea','#764ba2','#f7971e','#11998e','#f093fb'];
  for (let i = 0; i < 18; i++) {
    const p = document.createElement('div');
    p.className = 'particle';
    const size = 20 + Math.random() * 60;
    p.style.cssText = `
      width:${size}px; height:${size}px;
      left:${Math.random()*100}%;
      background:${colors[Math.floor(Math.random()*colors.length)]};
      animation-duration:${8+Math.random()*12}s;
      animation-delay:${Math.random()*8}s;
    `;
    container.appendChild(p);
  }
}

// â”€â”€ Number Controls â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function adjustValue(id, delta) {
  const el = document.getElementById(id);
  let val = parseFloat(el.value) || 0;
  val = Math.round((val + delta) * 10) / 10;
  if (id === 'sets') {
    val = Math.max(1, Math.round(val));
  } else {
    val = Math.max(0.5, val);
  }
  el.value = val;
  calcTotal();
}

function calcTotal() {
  const w = parseFloat(document.getElementById('walk-min').value) || 0;
  const j = parseFloat(document.getElementById('jog-min').value) || 0;
  const s = parseInt(document.getElementById('sets').value) || 0;
  // Each set = walk + jog (including the last set's jog)
  const total = s > 0 ? (w + j) * s : 0;
  document.getElementById('est-total').textContent = total.toFixed(1) + ' åˆ†é˜';
}

// â”€â”€ Audio â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function initAudio() {
  if (!audioCtx) {
    const AC = window.AudioContext || window.webkitAudioContext;
    audioCtx = new AC();
  }
  if (audioCtx.state === 'suspended') audioCtx.resume();
  // Unlock with a silent oscillator
  const osc = audioCtx.createOscillator();
  const g = audioCtx.createGain();
  g.gain.value = 0;
  osc.connect(g); g.connect(audioCtx.destination);
  osc.start(); osc.stop(audioCtx.currentTime + 0.001);
}

function playTone(freq, type, dur, vol = 0.6) {
  if (!audioCtx) return;
  const osc = audioCtx.createOscillator();
  const g = audioCtx.createGain();
  osc.type = type;
  osc.frequency.setValueAtTime(freq, audioCtx.currentTime);
  g.gain.setValueAtTime(vol, audioCtx.currentTime);
  g.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + dur);
  osc.connect(g); g.connect(audioCtx.destination);
  osc.start(); osc.stop(audioCtx.currentTime + dur);
}

// Friendly beep sequences
function playWalkStart() {
  // Light, cheerful two-tone
  playTone(523, 'sine', 0.18, 0.5);
  setTimeout(() => playTone(659, 'sine', 0.25, 0.5), 180);
}
function playJogStart() {
  // Energetic three-tone burst
  playTone(440, 'square', 0.12, 0.4);
  setTimeout(() => playTone(554, 'square', 0.12, 0.4), 120);
  setTimeout(() => playTone(659, 'square', 0.2, 0.4), 240);
}
function playCountdownBeep() {
  // Soft tick
  playTone(880, 'sine', 0.1, 0.3);
}
function playFinishFanfare() {
  // Victory melody
  const notes = [523, 659, 784, 1047];
  notes.forEach((f, i) => setTimeout(() => playTone(f, 'sine', 0.4, 0.6), i * 160));
}
function playWarningBeep() {
  // Double beep for countdown < 5
  playTone(1100, 'sine', 0.08, 0.5);
  setTimeout(() => playTone(1100, 'sine', 0.08, 0.5), 100);
}

// â”€â”€ Speech â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Cache selected female voice after first pick
let _femaleVoice = null;

function pickFemaleVoice() {
  if (_femaleVoice) return _femaleVoice;

  const voices = window.speechSynthesis.getVoices();
  if (!voices.length) return null;

  // Priority list: real TTS female voices, best first
  // macOS: Mei-Jia (zh-TW) / Ting-Ting (zh-CN)
  // iOS/Safari: ç¾ä½³ / å©·å©·
  // Windows: Microsoft Hanhan / Yaoyao / HiuMaan / Zhiwei
  // Google: Google æ™®é€šè©± (female by default)
  const FEMALE_KEYWORDS = [
    'mei-jia', 'meijia', 'ç¾ä½³',
    'ting-ting', 'tingting', 'å©·å©·',
    'hiumaan', 'hiu maan',
    'xiaochen', 'xiao chen', 'æ›‰è‡»', 'æ›‰è¾°',
    'zhiwei', 'zhi wei',
    'yaoyao', 'yao yao',
    'hanhan', 'han han',
    'linlin', 'lin lin',
    'google æ™®é€šè©±', 'google zh',
  ];
  const MALE_KEYWORDS = [
    'kangkang', 'kang kang', 'liang', 'danny', 'yu',
    'male', 'man', 'ç”·',
  ];

  // Score each zh voice: female keyword â†’ high score, male keyword â†’ negative
  let best = null, bestScore = -Infinity;
  for (const v of voices) {
    const isZh = /zh|cmn|yue/i.test(v.lang);
    if (!isZh) continue;
    const nameLower = v.name.toLowerCase();
    let score = 0;
    for (const kw of FEMALE_KEYWORDS) if (nameLower.includes(kw)) score += 10;
    for (const kw of MALE_KEYWORDS)   if (nameLower.includes(kw)) score -= 20;
    if (score > bestScore) { bestScore = score; best = v; }
  }
  _femaleVoice = best;
  return best;
}

function speak(text, rate = 1.05, pitch = 1.25) {
  if (!window.speechSynthesis) return;
  window.speechSynthesis.cancel();

  const utter = new SpeechSynthesisUtterance(text);
  utter.lang = 'zh-TW';
  utter.rate = rate;    // slightly faster = more energetic
  utter.pitch = pitch;  // higher = brighter female tone
  utter.volume = 1;

  const voice = pickFemaleVoice();
  if (voice) utter.voice = voice;

  window.speechSynthesis.speak(utter);
}

// â”€â”€ Wake Lock â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function requestWakeLock() {
  if ('wakeLock' in navigator) {
    try { wakeLock = await navigator.wakeLock.request('screen'); } catch {}
  }
}
function releaseWakeLock() {
  if (wakeLock) { wakeLock.release().then(() => wakeLock = null); }
}

// â”€â”€ Workout Control â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function startWorkout() {
  const w = parseFloat(document.getElementById('walk-min').value);
  const j = parseFloat(document.getElementById('jog-min').value);
  totalSets = parseInt(document.getElementById('sets').value);

  if (isNaN(w) || isNaN(j) || isNaN(totalSets) || w <= 0 || j <= 0 || totalSets <= 0) {
    speak('è«‹å…ˆè¨­å®šæœ‰æ•ˆçš„è¨“ç·´åƒæ•¸å–”ï¼', 1.05, 1.25);
    return;
  }

  walkSec = Math.round(w * 60);
  jogSec = Math.round(j * 60);

  initAudio();
  requestWakeLock();

  document.getElementById('setup').style.display = 'none';
  document.getElementById('workout-area').style.display = 'block';
  document.getElementById('active-workout').style.display = 'block';
  document.getElementById('completion-screen').style.display = 'none';

  currentSet = 1;
  isWalkPhase = true;
  isPaused = false;
  timeLeft = walkSec;
  phaseTotalSec = walkSec;

  buildPhaseBar();
  updateUI();
  resetPauseBtn();

  setTimeout(() => {
    speak('å¥½ï¼è¨“ç·´é–‹å§‹å›‰ï¼é›å›ï¼Œä¾†å§ï¼åŠ æ²¹ï¼', 1.08, 1.3);
    playWalkStart();
  }, 400);

  clearInterval(timer);
  timer = setInterval(countdown, 1000);
}

function togglePause() {
  isPaused = !isPaused;
  const btn = document.getElementById('pause-btn');
  if (isPaused) {
    btn.textContent = 'â–¶ ç¹¼çºŒ';
    btn.classList.add('is-paused');
    speak('å·²æš«åœï¼Œå–˜å£æ°£ï¼Œç­‰ä½ å›ä¾†ï¼', 1.0, 1.2);
  } else {
    btn.textContent = 'â¸ æš«åœ';
    btn.classList.remove('is-paused');
    speak('ç¹¼çºŒï¼é›å›æœ€æ£’äº†ï¼è¡è¡è¡ï¼', 1.1, 1.3);
  }
}

function resetPauseBtn() {
  const btn = document.getElementById('pause-btn');
  btn.textContent = 'â¸ æš«åœ';
  btn.classList.remove('is-paused');
}

function confirmStop() {
  if (confirm('ç¢ºå®šè¦çµæŸé€™æ¬¡è¨“ç·´å—ï¼Ÿ')) {
    finishWorkout(false);
  }
}

function countdown() {
  if (isPaused) return;
  timeLeft--;

  // Countdown warning sounds
  if (timeLeft <= 3 && timeLeft > 0) {
    playWarningBeep();
  } else if (timeLeft <= 8 && timeLeft > 3) {
    playCountdownBeep();
  }

  // Countdown speech
  if (timeLeft === 5) {
    speak('æº–å‚™åˆ‡æ›ï¼äº”ã€å››ã€ä¸‰ã€äºŒã€ä¸€ï¼', 1.12, 1.3);
  }

  updateTimerArc();
  updateTimerDisplay();

  if (timeLeft <= 0) {
    handlePhaseEnd();
  }
}

function handlePhaseEnd() {
  if (isWalkPhase) {
    // Walk done â†’ always switch to jog (every set has walk + jog)
    markPhaseComplete(currentSet - 1, 'walk');
    isWalkPhase = false;
    timeLeft = jogSec;
    phaseTotalSec = jogSec;
    updateUI();
    playJogStart();
    setTimeout(() => speak(`ç¬¬${currentSet}çµ„æ…¢è·‘é–‹å§‹ï¼è¡å•Šï¼åŠ é€Ÿï¼ä½ è¶…å¼·çš„ï¼`, 1.1, 1.32), 300);
  } else {
    // Jog done â†’ this set is complete
    markPhaseComplete(currentSet - 1, 'jog');
    if (currentSet >= totalSets) {
      // All sets done!
      finishWorkout(true);
      return;
    }
    // Move to next set, start walk
    currentSet++;
    isWalkPhase = true;
    timeLeft = walkSec;
    phaseTotalSec = walkSec;
    updateUI();
    playWalkStart();
    setTimeout(() => speak(`å¤ªæ£’äº†ï¼ç¬¬${currentSet}çµ„ï¼Œå¿«èµ°ï¼Œèª¿æ•´å‘¼å¸ï¼ä½ åšåˆ°äº†ï¼`, 1.05, 1.25), 300);
  }
}

function finishWorkout(completed) {
  clearInterval(timer);
  releaseWakeLock();

  if (completed) {
    saveRecord();
    launchConfetti();
    playFinishFanfare();
    setTimeout(() => {
      speak('æ­å–œæ­å–œï¼è¨“ç·´å®Œæˆï¼é›å›ï¼Œä½ ä»Šå¤©çœŸçš„éå¸¸éå¸¸æ£’ï¼ç‚ºè‡ªå·±é¼“é¼“æŒï¼ä¸‹æ¬¡ç¹¼çºŒåŠªåŠ›ï¼Œä½ æ˜¯æœ€å²å®³çš„ï¼', 0.95, 1.28);
    }, 600);
  }

  document.getElementById('active-workout').style.display = 'none';
  document.getElementById('completion-screen').style.display = 'block';
}

function resetToSetup() {
  document.getElementById('workout-area').style.display = 'none';
  document.getElementById('setup').style.display = 'block';
  updateHistoryTable();
}

// â”€â”€ UI Updates â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function updateUI() {
  updateTimerDisplay();
  updateTimerArc();
  updateStatusBadge();
  updateSetInfo();
  updateMotivation();
  updatePhaseBar();
}

function updateTimerDisplay() {
  const m = Math.floor(timeLeft / 60).toString().padStart(2, '0');
  const s = (timeLeft % 60).toString().padStart(2, '0');
  const el = document.getElementById('timer-display');
  el.textContent = `${m}:${s}`;

  // Heartbeat animation when < 6s
  if (timeLeft <= 5 && timeLeft > 0) {
    el.classList.remove('heartbeat');
    void el.offsetWidth;
    el.classList.add('heartbeat');
  }
}

function updateTimerArc() {
  const arc = document.getElementById('timer-arc');
  const circumference = 628; // 2 * pi * 100
  const fraction = phaseTotalSec > 0 ? timeLeft / phaseTotalSec : 0;
  arc.style.strokeDashoffset = circumference * (1 - fraction);
  arc.setAttribute('stroke', isWalkPhase ? 'url(#walkGrad)' : 'url(#jogGrad)');
}

function updateStatusBadge() {
  const badge = document.getElementById('status-badge');
  badge.className = 'status-badge ' + (isWalkPhase ? 'badge-walk' : 'badge-jog');
  badge.textContent = isWalkPhase ? 'ğŸš¶ å¿«èµ°éšæ®µ' : 'ğŸƒ æ…¢è·‘éšæ®µ';
}

function updateSetInfo() {
  document.getElementById('set-info').textContent = `ç¬¬ ${currentSet} çµ„ ï¼ å…± ${totalSets} çµ„`;
}

function updateMotivation() {
  const msgs = isWalkPhase ? WALK_MSGS : JOG_MSGS;
  const msg = msgs[Math.floor(Math.random() * msgs.length)];
  const el = document.getElementById('motivation-msg');
  el.style.opacity = '0';
  setTimeout(() => { el.textContent = msg; el.style.opacity = '1'; }, 200);
}

// â”€â”€ Phase Bar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function buildPhaseBar() {
  const bar = document.getElementById('phase-bar');
  bar.innerHTML = '';
  // Each set = walk + jog â†’ totalSets * 2 segments
  // Pattern: walk1, jog1, walk2, jog2, ..., walkN, jogN
  const totalSegments = totalSets * 2;
  for (let i = 0; i < totalSegments; i++) {
    const seg = document.createElement('div');
    seg.className = 'phase-seg';
    seg.id = `seg-${i}`;
    bar.appendChild(seg);
  }
  updatePhaseBar();
}

function updatePhaseBar() {
  const totalSegments = totalSets * 2;
  // seg index: even = walk, odd = jog
  // set number for seg i = Math.floor(i / 2) + 1
  for (let i = 0; i < totalSegments; i++) {
    const seg = document.getElementById(`seg-${i}`);
    if (!seg) continue;
    const isWalkSeg = i % 2 === 0;
    const setNum = Math.floor(i / 2) + 1;

    let isDone = false;
    let isActive = false;

    if (setNum < currentSet) {
      isDone = true;
    } else if (setNum === currentSet) {
      if (isWalkSeg) {
        if (isWalkPhase) isActive = true;
        else isDone = true; // walk finished, now jogging
      } else {
        if (!isWalkPhase) isActive = true;
        // if still in walk phase, jog seg stays grey
      }
    }

    seg.className = 'phase-seg';
    if (isActive) seg.classList.add('active');
    else if (isDone) seg.classList.add(isWalkSeg ? 'walk-done' : 'jog-done');
  }
}

function markPhaseComplete(setIdx, type) {
  // Called when a phase ends
  updatePhaseBar();
}

// â”€â”€ Confetti â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function launchConfetti() {
  const colors = ['#ffd200','#f7971e','#11998e','#38ef7d','#f093fb','#667eea','#fff'];
  for (let i = 0; i < 60; i++) {
    setTimeout(() => {
      const piece = document.createElement('div');
      piece.className = 'confetti-piece';
      piece.style.cssText = `
        left:${Math.random()*100}vw;
        background:${colors[Math.floor(Math.random()*colors.length)]};
        width:${6+Math.random()*10}px;
        height:${6+Math.random()*10}px;
        border-radius:${Math.random()>0.5?'50%':'2px'};
        animation-duration:${2+Math.random()*2}s;
        animation-delay:${Math.random()*0.5}s;
      `;
      document.body.appendChild(piece);
      setTimeout(() => piece.remove(), 3000);
    }, i * 30);
  }
}

// â”€â”€ History â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function saveRecord() {
  const totalMin = (((walkSec + jogSec) * totalSets) / 60).toFixed(1);
  const now = new Date();
  const pad = n => String(n).padStart(2,'0');
  const dateStr = `${now.getFullYear()}-${pad(now.getMonth()+1)}-${pad(now.getDate())} ${pad(now.getHours())}:${pad(now.getMinutes())}`;
  const wMin = document.getElementById('walk-min').value;
  const jMin = document.getElementById('jog-min').value;
  const record = { date: dateStr, setting: `å¿«${wMin}/æ…¢${jMin}/${totalSets}çµ„`, total: totalMin };
  const history = JSON.parse(localStorage.getItem('workoutHistory') || '[]');
  history.push(record);
  localStorage.setItem('workoutHistory', JSON.stringify(history));
}

function updateHistoryTable() {
  const history = JSON.parse(localStorage.getItem('workoutHistory') || '[]');
  const tbody = document.getElementById('history-body');
  tbody.innerHTML = '';
  if (history.length === 0) {
    tbody.innerHTML = '<tr><td colspan="4" style="color:rgba(255,255,255,0.25);text-align:center;padding:12px">é‚„æ²’æœ‰ç´€éŒ„ï¼Œå¿«å»è¨“ç·´ï¼ğŸ’ª</td></tr>';
    return;
  }
  for (let i = history.length - 1; i >= 0; i--) {
    const r = history[i];
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${r.date}</td>
      <td>${r.setting}</td>
      <td style="text-align:center">${r.total}</td>
      <td><button class="btn-del" onclick="deleteRecord(${i})">âœ•</button></td>
    `;
    tbody.appendChild(tr);
  }
}

function deleteRecord(i) {
  if (!confirm('ç¢ºå®šåˆªé™¤é€™ç­†ç´€éŒ„ï¼Ÿ')) return;
  const history = JSON.parse(localStorage.getItem('workoutHistory') || '[]');
  history.splice(i, 1);
  localStorage.setItem('workoutHistory', JSON.stringify(history));
  updateHistoryTable();
}

function clearAll() {
  const h = JSON.parse(localStorage.getItem('workoutHistory') || '[]');
  if (h.length === 0) { alert('ç›®å‰æ²’æœ‰ç´€éŒ„ï¼'); return; }
  if (confirm('ç¢ºå®šæ¸…ç©ºæ‰€æœ‰é‹å‹•ç´€éŒ„ï¼Ÿ')) {
    localStorage.removeItem('workoutHistory');
    updateHistoryTable();
  }
}

function downloadCSV() {
  const history = JSON.parse(localStorage.getItem('workoutHistory') || '[]');
  if (history.length === 0) { alert('æ²’æœ‰ç´€éŒ„å¯ä¸‹è¼‰ï¼'); return; }
  let csv = '\uFEFFæ—¥æœŸ,è¨­å®š,ç¸½æ™‚é–“(åˆ†)\n';
  history.forEach(r => { csv += `${r.date},${r.setting},${r.total}\n`; });
  const a = document.createElement('a');
  a.href = 'data:text/csv;charset=utf-8,' + encodeURIComponent(csv);
  a.download = 'workout_log.csv';
  a.click();
}

// â”€â”€ Init â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
window.onload = function () {
  initParticles();
  calcTotal();
  updateHistoryTable();

  // Pre-load & cache voices; reset cached voice whenever list refreshes
  if (window.speechSynthesis) {
    window.speechSynthesis.getVoices();
    window.speechSynthesis.onvoiceschanged = () => {
      _femaleVoice = null;   // force re-pick with fresh list
      pickFemaleVoice();     // warm up the cache
    };
  }
};
</script>
</body>
</html>
